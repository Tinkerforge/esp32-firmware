From 84d66d04511edab3be8c2f62f982f342326522e4 Mon Sep 17 00:00:00 2001
From: Erik Fleckstein <erik@tinkerforge.com>
Date: Wed, 16 Oct 2024 10:49:53 +0200
Subject: [PATCH] Remove automatic reconnect if first connect after startup
 fails.

---
 libraries/WiFi/src/STA.cpp | 7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/libraries/WiFi/src/STA.cpp b/libraries/WiFi/src/STA.cpp
index 443d2621..582d5c52 100644
--- a/libraries/WiFi/src/STA.cpp
+++ b/libraries/WiFi/src/STA.cpp
@@ -106,7 +106,6 @@ static void _onStaArduinoEvent(arduino_event_t *ev) {
   if (_sta_network_if == NULL || ev->event_id < ARDUINO_EVENT_WIFI_STA_START || ev->event_id > ARDUINO_EVENT_WIFI_STA_LOST_IP) {
     return;
   }
-  static bool first_connect = true;
   log_v("Arduino STA Event: %d - %s", ev->event_id, Network.eventName(ev->event_id));
 
   if (ev->event_id == ARDUINO_EVENT_WIFI_STA_START) {
@@ -135,7 +134,7 @@ static void _onStaArduinoEvent(arduino_event_t *ev) {
     log_w("Reason: %u - %s", reason, WiFi.STA.disconnectReasonName((wifi_err_reason_t)reason));
     if (reason == WIFI_REASON_NO_AP_FOUND) {
       _sta_network_if->_setStatus(WL_NO_SSID_AVAIL);
-    } else if ((reason == WIFI_REASON_AUTH_FAIL) && !first_connect) {
+    } else if ((reason == WIFI_REASON_AUTH_FAIL)) {
       _sta_network_if->_setStatus(WL_CONNECT_FAILED);
     } else if (reason == WIFI_REASON_BEACON_TIMEOUT || reason == WIFI_REASON_HANDSHAKE_TIMEOUT) {
       _sta_network_if->_setStatus(WL_CONNECTION_LOST);
@@ -147,10 +146,6 @@ static void _onStaArduinoEvent(arduino_event_t *ev) {
 
     bool DoReconnect = false;
     if (reason == WIFI_REASON_ASSOC_LEAVE) {  //Voluntarily disconnected. Don't reconnect!
-    } else if (first_connect) {               //Retry once for all failure reasons
-      first_connect = false;
-      DoReconnect = true;
-      log_d("WiFi Reconnect Running");
     } else if (_sta_network_if->getAutoReconnect() && _is_staReconnectableReason(reason)) {
       DoReconnect = true;
       log_d("WiFi AutoReconnect Running");
-- 
2.47.0

