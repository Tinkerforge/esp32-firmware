From e9f4396e362918b8fe535c764b222dcec941f8e2 Mon Sep 17 00:00:00 2001
From: Erik Fleckstein <erik@tinkerforge.com>
Date: Wed, 16 Oct 2024 10:54:17 +0200
Subject: [PATCH] WiFi: Disable 11b rates

802.11b has been obsolete for about 20 years. Keeping compatibility around
slows down devices not 20 years old.
---
 libraries/WiFi/src/WiFiGeneric.cpp | 16 ++++++++++++++++
 libraries/WiFi/src/WiFiGeneric.h   |  2 ++
 2 files changed, 18 insertions(+)

diff --git a/libraries/WiFi/src/WiFiGeneric.cpp b/libraries/WiFi/src/WiFiGeneric.cpp
index ccc95181..2f363389 100644
--- a/libraries/WiFi/src/WiFiGeneric.cpp
+++ b/libraries/WiFi/src/WiFiGeneric.cpp
@@ -333,6 +333,7 @@ static bool espWiFiStop() {
 
 bool WiFiGenericClass::_persistent = true;
 bool WiFiGenericClass::_long_range = false;
+bool WiFiGenericClass::_disable_sta_11b = true;
 wifi_mode_t WiFiGenericClass::_forceSleepLastMode = WIFI_MODE_NULL;
 #if CONFIG_IDF_TARGET_ESP32S2
 wifi_ps_type_t WiFiGenericClass::_sleepEnabled = WIFI_PS_NONE;
@@ -444,6 +445,15 @@ void WiFiGenericClass::enableLongRange(bool enable) {
   _long_range = enable;
 }
 
+/**
+ * disable 11b rates
+ * @param disable
+ */
+void WiFiGenericClass::disableSTA11b(bool disable)
+{
+    _disable_sta_11b = disable;
+}
+
 /**
  * set new mode
  * @param m WiFiMode_t
@@ -526,6 +536,12 @@ bool WiFiGenericClass::mode(wifi_mode_t m) {
       }
     }
   }
+  // 11b is long obsolete. true = disable. Don't care if it can't be disabled.
+  // Disable both because neither can be changed when trying to switch mode later.
+  // Always disable 11b on AP because beacons are sent at minimum rate.
+  esp_wifi_config_11b_rate(WIFI_IF_STA, _disable_sta_11b);
+  esp_wifi_config_11b_rate(WIFI_IF_AP, true);
+
   if (!espWiFiStart()) {
     return false;
   }
diff --git a/libraries/WiFi/src/WiFiGeneric.h b/libraries/WiFi/src/WiFiGeneric.h
index 2a5ca812..1886b95b 100644
--- a/libraries/WiFi/src/WiFiGeneric.h
+++ b/libraries/WiFi/src/WiFiGeneric.h
@@ -92,6 +92,7 @@ public:
 
   void persistent(bool persistent);
   void enableLongRange(bool enable);
+  void disableSTA11b(bool disable);
 
   static bool mode(wifi_mode_t);
   static wifi_mode_t getMode();
@@ -133,6 +134,7 @@ public:
 protected:
   static bool _persistent;
   static bool _long_range;
+  static bool _disable_sta_11b;
   static wifi_mode_t _forceSleepLastMode;
   static wifi_ps_type_t _sleepEnabled;
   static bool _wifiUseStaticBuffers;
-- 
2.47.0

