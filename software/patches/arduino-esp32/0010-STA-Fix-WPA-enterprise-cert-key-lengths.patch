From 9afa90f11455c7c5f3741b19420b6ade6bbe8306 Mon Sep 17 00:00:00 2001
From: Erik Fleckstein <erik@tinkerforge.com>
Date: Wed, 16 Oct 2024 13:45:32 +0200
Subject: [PATCH] STA: Fix WPA enterprise cert/key lengths.

The eap_client wants lengths including the null terminator.
---
 libraries/WiFi/src/STA.cpp | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/libraries/WiFi/src/STA.cpp b/libraries/WiFi/src/STA.cpp
index 5649bd53..c13b0da2 100644
--- a/libraries/WiFi/src/STA.cpp
+++ b/libraries/WiFi/src/STA.cpp
@@ -477,17 +477,17 @@ bool STAClass::connect(
 
   if (ca_pem) {
 #if __has_include("esp_eap_client.h")
-    esp_eap_client_set_ca_cert((uint8_t *)ca_pem, strlen(ca_pem));
+    esp_eap_client_set_ca_cert((uint8_t *)ca_pem, strlen(ca_pem) + 1);
 #else
-    esp_wifi_sta_wpa2_ent_set_ca_cert((uint8_t *)ca_pem, strlen(ca_pem));
+    esp_wifi_sta_wpa2_ent_set_ca_cert((uint8_t *)ca_pem, strlen(ca_pem) + 1);
 #endif
   }
 
   if (client_crt) {
 #if __has_include("esp_eap_client.h")
-    esp_eap_client_set_certificate_and_key((uint8_t *)client_crt, strlen(client_crt), (uint8_t *)client_key, strlen(client_key), NULL, 0);
+    esp_eap_client_set_certificate_and_key((uint8_t *)client_crt, strlen(client_crt) + 1, (uint8_t *)client_key, strlen(client_key) + 1, NULL, 0);
 #else
-    esp_wifi_sta_wpa2_ent_set_cert_key((uint8_t *)client_crt, strlen(client_crt), (uint8_t *)client_key, strlen(client_key), NULL, 0);
+    esp_wifi_sta_wpa2_ent_set_cert_key((uint8_t *)client_crt, strlen(client_crt) + 1, (uint8_t *)client_key, strlen(client_key) + 1, NULL, 0);
 #endif
   }
 
-- 
2.47.0

